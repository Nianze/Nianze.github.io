<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="刀心の水">
<meta name="keywords" content=", visual, music, technology">
<meta name="description" content="Replace pointer class members with their corresponding smart pointer objects to fortify the constructors against resource leaks in the presence of exceptions, to eliminate the need to manually deallocate resources in destructors, and to allow const member pointers to be handled in the smae graceful fashion as non-const pointers.">


<meta property="og:description" content="Replace pointer class members with their corresponding smart pointer objects to fortify the constructors against resource leaks in the presence of exceptions, to eliminate the need to manually deallocate resources in destructors, and to allow const member pointers to be handled in the smae graceful fashion as non-const pointers.">
<meta property="og:type" content="article">
<meta property="og:title" content="[MECpp]Item-10 Prevent Resource Leaks in Constructors">
<meta name="twitter:title" content="[MECpp]Item-10 Prevent Resource Leaks in Constructors">
<meta property="og:url" content="http://nianze.tk/2018/04/prevent-resource-leaks-in-constructors/">
<meta property="twitter:url" content="http://nianze.tk/2018/04/prevent-resource-leaks-in-constructors/">
<meta property="og:site_name" content="Be creative">
<meta property="og:description" content="Replace pointer class members with their corresponding smart pointer objects to fortify the constructors against resource leaks in the presence of exceptions, to eliminate the need to manually deallocate resources in destructors, and to allow const member pointers to be handled in the smae graceful fashion as non-const pointers.">
<meta name="twitter:description" content="Replace pointer class members with their corresponding smart pointer objects to fortify the constructors against resource leaks in the presence of exceptions, to eliminate the need to manually deallocate resources in destructors, and to allow const member pointers to be handled in the smae graceful fashion as non-const pointers.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2018-04-02T15:56:25">
  
  
    <meta property="article:modified_time" content="2018-04-02T15:56:25">
  
  
  
    
      <meta property="article:section" content="technology">
    
      <meta property="article:section" content="coding">
    
  
  
    
      <meta property="article:tag" content="technique">
    
      <meta property="article:tag" content="cpp">
    
  


<meta name="twitter:card" content="summary">







  <meta property="og:image" content="http://nianze.tk/images/2018/2018-04/2018-04-02.gif">
  <meta property="twitter:image" content="http://nianze.tk/images/2018/2018-04/2018-04-02.gif">





  <meta property="og:image" content="http://nianze.tk/images/bw.JPG">
  <meta property="twitter:image" content="http://nianze.tk/images/bw.JPG">


    <title>[MECpp]Item-10 Prevent Resource Leaks in Constructors</title>

    <link rel="icon" href="http://nianze.tk/favicon.png">
    

    

    <link rel="canonical" href="http://nianze.tk/2018/04/prevent-resource-leaks-in-constructors/">

    
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="http://nianze.tk/css/style-nnm2spxvve8onlujjlegkkytaehyadd4ksxc1hyzzq9a2wvtrgbljqyulomn.min.css" />
    
    
      
        <link rel="stylesheet" href="http://nianze.tk/css/main.css">
      
    
      
        <link rel="stylesheet" href="http://nianze.tk/css/loader.css">
      
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-71584380-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
    
  </head>

  <body id="container">
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fas fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="http://nianze.tk/">Be creative</a>
  </div>
  
    
      <a class="header-right-picture "
         href="http://nianze.tk/#about">
    
    
    
      
        <img class="header-picture" src="http://nianze.tk/images/bw.JPG" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="http://nianze.tk/#about">
          <img class="sidebar-profile-picture" src="http://nianze.tk/images/bw.JPG" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">刀心の水</h4>
        
          <h5 class="sidebar-profile-bio"><p>虚度廿余岁月浅，略识几行代码源。<br />
闲来随手快门按，怆然独把音韵弹。</p>

<p>Pain is inevitable.<br />
Suffering is optional.</p>
</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/">
    
      <i class="sidebar-button-icon fas fa-home" title='Home'></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/thoughts">
    
      <i class="sidebar-button-icon fas fa-lightbulb" title='Thoughts'></i>
      
      <span class="sidebar-button-desc">Thoughts</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/technology">
    
      <i class="sidebar-button-icon fas fa-code" title='Technology'></i>
      
      <span class="sidebar-button-desc">Technology</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/music">
    
      <i class="sidebar-button-icon fas fa-music" title='Music'></i>
      
      <span class="sidebar-button-desc">Music</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/visual">
    
      <i class="sidebar-button-icon fas fa-palette" title='Visual'></i>
      
      <span class="sidebar-button-desc">Visual</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories">
    
      <i class="sidebar-button-icon fas fa-bookmark" title='Categories'></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/tags">
    
      <i class="sidebar-button-icon fas fa-tags" title='Tags'></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/archives">
    
      <i class="sidebar-button-icon fas fa-archive" title='Archives'></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/about">
    
      <i class="sidebar-button-icon fas fa-user" title='About'></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.linkedin.com/in/nianze" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-linkedin" title='LinkedIn'></i>
      
      <span class="sidebar-button-desc">LinkedIn</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/Nianze" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-github" title='Github'></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.flickr.com/photos/129774362@N07/" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-flickr", title='Flickr'></i>
      
      <span class="sidebar-button-desc">Flickr</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://instagram.com/eznain" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-instagram" title='Instagram'></i>
      
      <span class="sidebar-button-desc">Instagram</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.facebook.com/rym.lnz" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-facebook", title='Facebook'></i>
      
      <span class="sidebar-button-desc">Facebook</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/daoxinzhishui" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-twitter", title='Twitter'></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.youtube.com/user/daoxinzhishui" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-youtube", title='YouTube'></i>
      
      <span class="sidebar-button-desc">YouTube</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="mailto:daoxinzhishui@gmail.com" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fas fa-envelope", title='Email'></i>
      
      <span class="sidebar-button-desc">Email</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/post/index.xml">
    
      <i class="sidebar-button-icon fas fa-rss-square", title='RSS'></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      [MECpp]Item-10 Prevent Resource Leaks in Constructors
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2018-04-02T15:56:25-04:00">
        
  April 2, 2018

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="http://nianze.tk/categories/technology">technology</a>, 
    
      <a class="category-link" href="http://nianze.tk/categories/coding">coding</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>Replace pointer class members with their corresponding smart pointer objects to fortify the constructors against resource leaks in the presence of exceptions, to eliminate the need to manually deallocate resources in destructors, and to allow <code>const</code> member pointers to be handled in the smae graceful fashion as non-<code>const</code> pointers.</p>

<h1 id="table-of-contents">Table of Contents</h1><nav id="TableOfContents">
<ul>
<li><a href="#example">Example</a></li>
<li><a href="#naive-implementation">Naive implementation</a></li>
<li><a href="#workable-but-inelegant-implementation">Workable (but inelegant) implementation</a></li>
<li><a href="#for-both-constant-and-non-const-pointers">For both <code>constant</code> and non-<code>const</code> pointers</a>
<ul>
<li><a href="#naive-implementation-1">Naive implementation</a></li>
<li><a href="#workable-design">Workable design</a></li>
<li><a href="#better-design">Better design</a></li>
</ul></li>
</ul>
</nav>

<h1 id="example">Example</h1>

<p>Suppose we want to develop a software for a multimedia address book that might hold information of a person&rsquo;s name, address, phone numbers, a picture of the person and, the sound of their voice:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Image</span> {  <span style="color:#75715e">// for holding image data
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    Image (<span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> imageDataFileName);
    ...
};

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AudioClip</span> {  <span style="color:#75715e">// for holding audio data
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    AudioClip(<span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> sudioDataFileName);
    ...
};

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PhoneNumber</span> {...}; <span style="color:#75715e">// for holding phone numbers
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BookEntry</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    BookEntry(<span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> name,  <span style="color:#75715e">// name data is mandatory for BookEntry, other fields are optional
</span><span style="color:#75715e"></span>              <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> address <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>,
              <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> imageFileName <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>,
              <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> audioClipFileName <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#f92672">~</span>BookEntry();
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addPhoneNumber</span>(<span style="color:#66d9ef">const</span> PhoneNumber<span style="color:#f92672">&amp;</span> number); <span style="color:#75715e">// phone numbers are added via this function
</span><span style="color:#75715e"></span>    ...
<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    string theName;
    string theAddress;
    list<span style="color:#f92672">&lt;</span>PhoneNumber<span style="color:#f92672">&gt;</span> thePhones;
    Image <span style="color:#f92672">*</span>theImage;
    AudioClip <span style="color:#f92672">*</span>theAudioClip;
};
</code></pre></div>
<h1 id="naive-implementation">Naive implementation</h1>

<p>A straightforward implementation for constructor and destructor:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">BookEntry<span style="color:#f92672">:</span><span style="color:#f92672">:</span>BookEntry(<span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> name,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> address,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> imageFileName,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> audioClipFileName)
<span style="color:#f92672">:</span> theName(name), theAddress(address),
  theImage(<span style="color:#ae81ff">0</span>), theAudioClip(<span style="color:#ae81ff">0</span>)
{
    <span style="color:#66d9ef">if</span> (imageFileName <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>) {
        theImage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Image(imageFileName);
    }
    <span style="color:#66d9ef">if</span> (audioClipFileName <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>) {
        theAudioClip <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AudioClip(audioClipFileName);
    }
}

BookEntry<span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span>BookEntry()
{
    <span style="color:#66d9ef">delete</span> theImage;  <span style="color:#75715e">// C++ guarantees it&#39;s safe to delete null pointers
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">delete</span> theAudoClip;
}
</code></pre></div>
<p>Everything looks good, however, there is potential resource leak under abnormal conditions: when an exception is thrown duringg exectuion of <code>theAudioClip = new AudioClip(audioClipFileName);</code>:</p>

<ul>
<li>An exception might arise because <code>operator new</code> (MECpp item 8) is unable to allocate enough memory for an <code>AudioClip</code> object, or coming from <code>AudioClip</code> constructor who throws an exception itself, ending up with a exception propagated to the site where the <code>BookEntry</code> object is being created</li>
<li>C++ destroys only <em>fully constructed</em> objects, and an object isn&rsquo;t fully constructed until its construtor has run to completion.</li>
<li>The exception propagated from <code>new AudioClip(audioClipFileName</code> interrupts the construction of the <code>BookEntry</code> object, so the <code>BookEntry</code>&rsquo;s destructor will never be called, and nobody will delete the object that <code>theImage</code> already points to.</li>
</ul>

<p>Note that adding <code>try...catch</code> outside of the <code>BookEntry</code> constructor does not help:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testBookEntryClass</span>()
{
    BookEntry <span style="color:#f92672">*</span>pb <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">try</span> {
        pb <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BookEntry(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Sherlock Holmes</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">221B Baker Street</span><span style="color:#e6db74">&#34;</span>);
        ...
    }
    <span style="color:#66d9ef">catch</span> (...) {  <span style="color:#75715e">// catch all exceptions
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">delete</span> pb; <span style="color:#75715e">// delete pb when an exception is thrown
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">throw</span>;     <span style="color:#75715e">// propagate exception to caller
</span><span style="color:#75715e"></span>    }
    <span style="color:#66d9ef">delete</span> pb;     <span style="color:#75715e">// delete pb normally
</span><span style="color:#75715e"></span>}
</code></pre></div>
<p>If <code>BookEntry</code>&rsquo;s constructor throws an exception, no assignment is made to <code>pb</code> and <code>pb</code> will be a null pointer, so deleting it in the <code>catch</code> block does nothing except make us feel better about ourselves.</p>

<h1 id="workable-but-inelegant-implementation">Workable (but inelegant) implementation</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">BookEntry<span style="color:#f92672">:</span><span style="color:#f92672">:</span>BookEntry(<span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> name,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> address,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> imageFileName,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> audioClipFileName)
<span style="color:#f92672">:</span> theName(name), theAddress(address),
  theImage(<span style="color:#ae81ff">0</span>), theAudioClip(<span style="color:#ae81ff">0</span>)
{
    <span style="color:#66d9ef">try</span> {
        <span style="color:#66d9ef">if</span> (imageFileName <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>) {
            theImage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Image(imageFileName);
        }
        <span style="color:#66d9ef">if</span> (audioClipFileName <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>) {
            theAudioClip <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AudioClip(audioClipFileName);
        }
    }
    <span style="color:#66d9ef">catch</span> (...) {               <span style="color:#75715e">// catch any exception
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">delete</span> theImage;        <span style="color:#75715e">// perform necessary cleanup actions
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">delete</span> theAudioClip;
        <span style="color:#66d9ef">throw</span>;                  <span style="color:#75715e">// propagate the exception
</span><span style="color:#75715e"></span>    }
}
</code></pre></div>
<p>For non-pointer data members such as <code>theName</code>, <code>theAddress</code>, and <code>thePhones</code>, they are automatically initialized before a class&rsquo;s constructor is called, so if a <code>BookEntry</code> constructor body begins exewcuting, they have already been fully constructed. As fully constructed objects, they will also be automatically destroyed even if an exception arises in  the <code>BookEntry</code> constructor.</p>

<p>Considering code duplication, we may move the common resource cleanup code into a private helper funciton and have both the constructor and the destructor call it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BookEntry</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    ... <span style="color:#75715e">// as before
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    ... 
    <span style="color:#66d9ef">void</span> cleanup();  <span style="color:#75715e">// common cleanup statement
</span><span style="color:#75715e"></span>};

<span style="color:#66d9ef">void</span> BookEntry<span style="color:#f92672">:</span><span style="color:#f92672">:</span>cleanup()
{
    <span style="color:#66d9ef">delete</span> theImage;
    <span style="color:#66d9ef">delete</span> theAudioClip;
}

BookEntry<span style="color:#f92672">:</span><span style="color:#f92672">:</span>BookEntry(<span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> name,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> address,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> imageFileName,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> audioClipFileName)
<span style="color:#f92672">:</span> theName(name), theAddress(address),
  theImage(<span style="color:#ae81ff">0</span>), theAudioClip(<span style="color:#ae81ff">0</span>)
{
    <span style="color:#66d9ef">try</span> {
        ...
    }
    <span style="color:#66d9ef">catch</span> (...) {               <span style="color:#75715e">// catch any exception
</span><span style="color:#75715e"></span>        cleanup();
        <span style="color:#66d9ef">throw</span>;                  <span style="color:#75715e">// propagate the exception
</span><span style="color:#75715e"></span>    }
}

BookEntry<span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span>BookEntry()
{
    cleanup();
}
</code></pre></div>
<hr />

<h1 id="for-both-constant-and-non-const-pointers">For both <code>constant</code> and non-<code>const</code> pointers</h1>

<p>What if <code>BookEntry</code> class interface is designed differently, with <code>theImage</code> and <code>theAudioClip</code> defined as <code>constant</code> pointers, which must be initialized via the member initialization lists:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BookEntry</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    ...
<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    ...
    Image <span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> theImage;
    AudioClip <span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> theAudioClip;
};
</code></pre></div>
<h2 id="naive-implementation-1">Naive implementation</h2>

<p>We may be tempted to initit <code>theImage</code> and <code>theAudioClip</code> like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// an implementation that may leak resources if an exception is thrown
</span><span style="color:#75715e"></span>BookEntry<span style="color:#f92672">:</span><span style="color:#f92672">:</span>BookEntry(<span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> name,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> address,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> imageFileName,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> audioClipFileName)
<span style="color:#f92672">:</span> theName(name), theAddress(address),
  theImage(imageFileName <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>
           <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> Image(imageFileName)
           <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>), 
  theAudioClip(audioClipFileName <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>
               <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> AudioClip(audioClipFileNAme)
               <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>)
{}
</code></pre></div>
<p>but this leads to the problem of potential resource leak: if an exception is thrown during initialization of <code>theAudioClip</code>, the object pointed to by <code>theImage</code> is never destroyed.</p>

<h2 id="workable-design">Workable design</h2>

<p>In order to add <code>try</code> and <code>catch</code> to perform cleanup tasks in a member initialization list, we may consider put them inside private member functions that return pointers:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BookEntry</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    ...
<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    ...
    Image <span style="color:#f92672">*</span> initImage(<span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> imageFileName);
    AudioClip <span style="color:#f92672">*</span> <span style="color:#a6e22e">initAudioClip</span>(<span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> audioClipFileName);
};

BookEntry<span style="color:#f92672">:</span><span style="color:#f92672">:</span>BookEntry(<span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> name,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> address,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> imageFileName,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> audioClipFileName)
<span style="color:#f92672">:</span> theName(name), theAddress(address),
  theImage(initImage(imageFileName)),
  theAudioClip(initAudioClip(audioClipFileName))
{}

<span style="color:#75715e">// theImage is init. first, so there&#39;s no need to worry about a resource leak
</span><span style="color:#75715e"></span><span style="color:#75715e">// if this initialization fails.
</span><span style="color:#75715e"></span>Image <span style="color:#f92672">*</span> BookEntry<span style="color:#f92672">:</span><span style="color:#f92672">:</span>initImage(<span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> imageFileName)
{
    <span style="color:#66d9ef">if</span> (imageFileName <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>) <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Image(imageFileName);
    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#75715e">// theAudioClip is initialized second, so it must take care of theImage&#39;s resources
</span><span style="color:#75715e"></span><span style="color:#75715e">// if an exception is thrown during initialization of theAudioClip 
</span><span style="color:#75715e"></span>AudioClip <span style="color:#f92672">*</span> BookEntry<span style="color:#f92672">:</span><span style="color:#f92672">:</span>initAudioClip(<span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> audioClipFileName)
{
    <span style="color:#66d9ef">try</span> {
        <span style="color:#66d9ef">if</span> (audioClipFileName <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>) {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">AudioClip</span>(audioClipFileName);
        }
        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
    }
    <span style="color:#66d9ef">catch</span> (...) {
        <span style="color:#66d9ef">delete</span> theImage;
        <span style="color:#66d9ef">throw</span>;
    }
}
</code></pre></div>
<p>This design works, but the drawback is that code that conceptually belongs in a constructor is now dispersed across several functions, and that&rsquo;s a maitenance headache.</p>

<h2 id="better-design">Better design</h2>

<p>A better design is to adopt the advise of MECpp Item 9 (as well as item 13):</p>

<ul>
<li>treat the objects pointed to by <code>theImage</code> and <code>theAudioClip</code> as resources to be managed by local objects (specifically, smart pointers).</li>
</ul>

<p>Since the resource here is of pointer types, we can use smart pointers to manage them. Take <code>auto_ptr</code> for example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BookEntry</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    ...
<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    ...
    <span style="color:#66d9ef">const</span> auto_ptr<span style="color:#f92672">&lt;</span>Image<span style="color:#f92672">&gt;</span> theImage;
    <span style="color:#66d9ef">const</span> auto_ptr<span style="color:#f92672">&lt;</span>AudioClip<span style="color:#f92672">&gt;</span> theAudioClip;
};

BookEntry<span style="color:#f92672">:</span><span style="color:#f92672">:</span>BookEntry(<span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> name,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> address,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> imageFileName,
                     <span style="color:#66d9ef">const</span> string<span style="color:#f92672">&amp;</span> audioClipFileName)
<span style="color:#f92672">:</span> theName(name), theAddress(address),
  theImage(imageFileName <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>
           <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> Image(imageFileName)
           <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>), 
  theAudioClip(audioClipFileName <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>
               <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> AudioClip(audioClipFileNAme)
               <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>)
{}

BookEntry<span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span>BookEntry()  <span style="color:#75715e">// nothing to do
</span><span style="color:#75715e"></span>{}                       
</code></pre></div>
<p>In this design, if an exception is thrown during initialization of <code>theAudioClip</code>, <code>theImage</code> is already a fully constructed object, so it will automatically be destroyed, jsut like <code>theName</code>, <code>theAddress</code>, and <code>thePhones</code>. Furthermore, because <code>theImage</code> and <code>theAudioClip</code> are now objects, they&rsquo;ll be destroyed automatically when the <code>BookEntry</code> object containing them is destroyed.</p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="http://nianze.tk/tags/technique/">technique</a>

  <a class="tag tag--primary tag--small" href="http://nianze.tk/tags/cpp/">cpp</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/04/prevent-exceptions-from-leaving-destructors/" data-tooltip="[MECpp]Item-11 Prevent Exceptions From Leaving Destructors">
              
                  <i class="fas fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/04/use-destructors-to-prevent-resource-leaks/" data-tooltip="[MECpp]Item-9 Use Destructors to Prevent Resource Leaks">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fas fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fas fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://nianze.tk/2018/04/prevent-resource-leaks-in-constructors/">
              <i class="fab fa-facebook-f"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://nianze.tk/2018/04/prevent-resource-leaks-in-constructors/">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://nianze.tk/2018/04/prevent-resource-leaks-in-constructors/">
              <i class="fab fa-google-plus-g"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#utteranc_thread" data-tooltip="Comments">
            <i class="fas fa-comment-dots"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#table-of-contents" data-tooltip="Table of Contents">
            <i class="fas fa-list"></i>
        
          </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="utteranc_thread">
  <script src="https://utteranc.es/client.js"
    repo= "Nianze/personal-site-comments"
    issue-term="pathname"
    theme="github-light"
    label="✨comment 💬"
    crossorigin="anonymous"
    async>
  </script>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2019 刀心の水. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/04/prevent-exceptions-from-leaving-destructors/" data-tooltip="[MECpp]Item-11 Prevent Exceptions From Leaving Destructors">
              
                  <i class="fas fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/04/use-destructors-to-prevent-resource-leaks/" data-tooltip="[MECpp]Item-9 Use Destructors to Prevent Resource Leaks">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fas fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fas fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://nianze.tk/2018/04/prevent-resource-leaks-in-constructors/">
              <i class="fab fa-facebook-f"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://nianze.tk/2018/04/prevent-resource-leaks-in-constructors/">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://nianze.tk/2018/04/prevent-resource-leaks-in-constructors/">
              <i class="fab fa-google-plus-g"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#utteranc_thread" data-tooltip="Comments">
            <i class="fas fa-comment-dots"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#table-of-contents" data-tooltip="Table of Contents">
            <i class="fas fa-list"></i>
        
          </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fas fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fnianze.tk%2F2018%2F04%2Fprevent-resource-leaks-in-constructors%2F">
          <i class="fa fa-facebook-f"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http%3A%2F%2Fnianze.tk%2F2018%2F04%2Fprevent-resource-leaks-in-constructors%2F">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http%3A%2F%2Fnianze.tk%2F2018%2F04%2Fprevent-resource-leaks-in-constructors%2F">
          <i class="fa fa-google-plus-g"></i><span>Share on Google&#43;</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fas fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="http://nianze.tk/images/bw.JPG" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">刀心の水</h4>
    
      <div id="about-card-bio"><p>虚度廿余岁月浅，略识几行代码源。<br />
闲来随手快门按，怆然独把音韵弹。</p>

<p>Pain is inevitable.<br />
Suffering is optional.</p>
</div>
    
    
      <div id="about-card-job">
        <i class="fas fa-laptop-code"></i>
        <br/>
        Developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fas fa-map-marked-alt"></i>
        <br/>
        New York
      </div>
    
  </div>
</div>

    

    
  
    
      
      <div id="cover" style="background-image:url('http://nianze.tk/images/reservoir.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/3.2.0/imagesloaded.pkgd.min.js"></script>


<script src="http://nianze.tk/js/script-qi9wbxp2ya2j6p7wx1i6tgavftewndznf4v0hy2gvivk1rxgc3lm7njqb6bz.min.js"></script>


  
    <script src="http://nianze.tk/js/loader.js"></script>
  

<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>





    
  </body>
</html>


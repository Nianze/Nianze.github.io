<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="刀心の水">
<meta name="keywords" content=", visual, music, technology">
<meta name="description" content="Avoid casts and develop a cast-free alternative whenever practical, especially dynamic_cast in performance-sensitive code.">


<meta property="og:description" content="Avoid casts and develop a cast-free alternative whenever practical, especially dynamic_cast in performance-sensitive code.">
<meta property="og:type" content="article">
<meta property="og:title" content="Item-27 Minimize_casting">
<meta name="twitter:title" content="Item-27 Minimize_casting">
<meta property="og:url" content="http://nianze.tk/2018/02/minimize-casting/">
<meta property="twitter:url" content="http://nianze.tk/2018/02/minimize-casting/">
<meta property="og:site_name" content="Be creative">
<meta property="og:description" content="Avoid casts and develop a cast-free alternative whenever practical, especially dynamic_cast in performance-sensitive code.">
<meta name="twitter:description" content="Avoid casts and develop a cast-free alternative whenever practical, especially dynamic_cast in performance-sensitive code.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2018-02-15T17:43:53">
  
  
    <meta property="article:modified_time" content="2018-02-15T17:43:53">
  
  
  
    
      <meta property="article:section" content="technology">
    
      <meta property="article:section" content="coding">
    
  
  
    
      <meta property="article:tag" content="technique">
    
      <meta property="article:tag" content="cpp">
    
  


<meta name="twitter:card" content="summary">







  <meta property="og:image" content="http://nianze.tk/images/2018/2018-02/2018-02-15.gif">
  <meta property="twitter:image" content="http://nianze.tk/images/2018/2018-02/2018-02-15.gif">





  <meta property="og:image" content="http://nianze.tk/images/profile/bw.JPG">
  <meta property="twitter:image" content="http://nianze.tk/images/profile/bw.JPG">


    <title>Item-27 Minimize_casting</title>

    <link rel="icon" href="http://nianze.tk/favicon.png">
    

    

    <link rel="canonical" href="http://nianze.tk/2018/02/minimize-casting/">

    
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="http://nianze.tk/css/style-nnm2spxvve8onlujjlegkkytaehyadd4ksxc1hyzzq9a2wvtrgbljqyulomn.min.css" />
    
    
      
        <link rel="stylesheet" href="http://nianze.tk/css/main.css">
      
    
      
        <link rel="stylesheet" href="http://nianze.tk/css/loader.css">
      
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-71584380-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
    
  </head>

  <body id="container">
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fas fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="http://nianze.tk/">Be creative</a>
  </div>
  
    
      <a class="header-right-picture "
         href="http://nianze.tk/#about">
    
    
    
      
        <img class="header-picture" src="http://nianze.tk/images/profile/bw.JPG" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="http://nianze.tk/#about">
          <img class="sidebar-profile-picture" src="http://nianze.tk/images/profile/bw.JPG" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">刀心の水</h4>
        
          <h5 class="sidebar-profile-bio"><p>虚度廿余岁月浅，略识几行代码源。<br />
闲来随手快门按，怆然独把音韵弹。</p>

<p>Pain is inevitable.<br />
Suffering is optional.</p>
</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/">
    
      <i class="sidebar-button-icon fas fa-home" title='Home'></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/thoughts">
    
      <i class="sidebar-button-icon fas fa-lightbulb" title='Thoughts'></i>
      
      <span class="sidebar-button-desc">Thoughts</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/technology">
    
      <i class="sidebar-button-icon fas fa-code" title='Technology'></i>
      
      <span class="sidebar-button-desc">Technology</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/music">
    
      <i class="sidebar-button-icon fas fa-music" title='Music'></i>
      
      <span class="sidebar-button-desc">Music</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/visual">
    
      <i class="sidebar-button-icon fas fa-palette" title='Visual'></i>
      
      <span class="sidebar-button-desc">Visual</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories">
    
      <i class="sidebar-button-icon fas fa-bookmark" title='Categories'></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/tags">
    
      <i class="sidebar-button-icon fas fa-tags" title='Tags'></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/archives">
    
      <i class="sidebar-button-icon fas fa-archive" title='Archives'></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/about">
    
      <i class="sidebar-button-icon fas fa-user" title='About'></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.linkedin.com/in/nianze" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-linkedin" title='LinkedIn'></i>
      
      <span class="sidebar-button-desc">LinkedIn</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/Nianze" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-github" title='Github'></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.flickr.com/photos/129774362@N07/" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-flickr", title='Flickr'></i>
      
      <span class="sidebar-button-desc">Flickr</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://instagram.com/eznain" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-instagram" title='Instagram'></i>
      
      <span class="sidebar-button-desc">Instagram</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.facebook.com/rym.lnz" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-facebook", title='Facebook'></i>
      
      <span class="sidebar-button-desc">Facebook</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/daoxinzhishui" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-twitter", title='Twitter'></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.youtube.com/user/daoxinzhishui" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-youtube", title='YouTube'></i>
      
      <span class="sidebar-button-desc">YouTube</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="mailto:daoxinzhishui@gmail.com" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fas fa-envelope", title='Email'></i>
      
      <span class="sidebar-button-desc">Email</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/post/index.xml">
    
      <i class="sidebar-button-icon fas fa-rss-square", title='RSS'></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Item-27 Minimize_casting
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2018-02-15T17:43:53-05:00">
        
  February 15, 2018

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="http://nianze.tk/categories/technology">technology</a>, 
    
      <a class="category-link" href="http://nianze.tk/categories/coding">coding</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>Avoid casts and develop a cast-free alternative whenever practical, especially <code>dynamic_cast</code> in performance-sensitive code.</p>

<p>Casts subvert the C++ type system, so it is a feature we want to approach with great respect.</p>

<h3 id="cast-style">Cast style</h3>

<p>There are three different ways to write the same cast:</p>

<ol>
<li><p>C-style casts:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">(T) expression <span style="color:#75715e">// cast expression to be of type T
</span></code></pre></div></li>

<li><p>Function-style casts</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">T(expression)  <span style="color:#75715e">// There&#39;s no difference in meaning between C-style and function-style casts. 
</span><span style="color:#75715e"></span>               <span style="color:#75715e">// Both of them are old-style casts
</span></code></pre></div></li>

<li><p>C++-style casts (new-style casts)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">const_cast</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>(expression)
<span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>(expression)
<span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>(expression)
<span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>(expression)
</code></pre></div>
<p>Each serves a distinct purpose:</p>

<ul>
<li><code>const_cast</code> is used to cast away the constness of objects, which is the only C++-style cast that can do this.</li>
<li><code>dynamic_cast</code> is primarily used to perform &ldquo;safe downcasting,&rdquo; i.e., to determine whether an object is of a particular type in an inheritance hierarchy. This is the only cast that cannot be performed using the old-style syntax. It is also the only cast that may have a significant runtime cost.</li>
<li><code>reinterpret_cast</code> in intended for low-level casts that yield implementation-dependent (i.e., unportable) results, e.g., casting a pointer to an <code>int</code>. Item 50 shows once its usage.</li>
<li><code>static_cast</code> is used to force implicit conversions (e.g., non-<code>const</code> object to <code>const</code> object (item3), <code>int</code> to <code>double</code>, etc.) as well as some reverse of such conversions (e.g., <code>void*</code> pointers to typed pointers, pointer-to-base to pointer-to-derived), but it cannot cast from <code>const</code> to non-<code>const</code> objects.</li>
</ul></li>
</ol>

<p>The good points of using new style casts are:<br />
1. new styles are much easier to identify in code for both humans and for tools like <code>grep</code>, thus simplifying the process of locating the code during debugging.<br />
2. The more narrowly specified purpose of each cast makes it possible for compilers to diagnose usage errors.</p>

<p>Sometimes an old-style cast may &ldquo;feel&rdquo; better: suppose we want to call an <code>explicit</code> constructor to pass an object to a function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Widget</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">explicit</span> Widget(<span style="color:#66d9ef">int</span> size);
    ...
};
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doSomeWork</span>(<span style="color:#66d9ef">const</span> Widget<span style="color:#f92672">&amp;</span> w);

doSomeWork(Widget(<span style="color:#ae81ff">15</span>));  <span style="color:#75715e">// create Widget from in with function-style cast
</span><span style="color:#75715e"></span>doSomeWork(<span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>Widget<span style="color:#f92672">&gt;</span>(<span style="color:#ae81ff">15</span>)); <span style="color:#75715e">// cast with C++-style
</span></code></pre></div>
<p>However, feeling is just feeling. Code that leads to a core dump also feels pretty reasonable when we write it - we&rsquo;d better ignore feelings and use new-style casts all the time.</p>

<h2 id="behind-cast">Behind cast</h2>

<p>Type conversions often lead to code that is executed at runtime, more than simply telling compilters to treat one type as another:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> x, y;
...
<span style="color:#66d9ef">double</span> d <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">double</span><span style="color:#f92672">&gt;</span>(x) <span style="color:#f92672">/</span> y;  <span style="color:#75715e">// divide x by y using floating point division
</span></code></pre></div>
<p>the cast from the <code>int x</code> to a <code>double</code> almost certainly generates code, because on most architectures, the underlying representation for an <code>int</code> is different from that for a <code>double</code>.</p>

<p>Let&rsquo;s see another example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Base</span> {...};
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Derived</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> Base {...};

Derived d;
Base <span style="color:#f92672">*</span>pb <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>d;  <span style="color:#75715e">// implicitly convert Derived* to Base*
</span></code></pre></div>
<p>When creating the base class pointer to a derived class object, sometimes, depending on the various compilers, an offset may be applied at runtime to the <code>Derived*</code> pointer to get the correct <code>Base*</code> pointer value, and now a single object of type <code>Derived</code> now have more than one address! This can&rsquo;t happen in Java, or C#, or C, but it <em>does</em> happen in C++, virtually all the time in the case of multiple inheritance, and some of the times under single inheritance.</p>

<p>The lesson we learn:</p>

<blockquote>
<p>we should generally avoid making assumptions about how things are laid out in C++, and certainly not perform casts based on such assumptions.</p>
</blockquote>

<p>For example: casting object addresses to <code>char*</code> pointers and then using pointer arithmetic on them almost always yields undefined behavior.</p>

<p>Another lesson we may learn from: many application frameworks requires that virtual member function implementations in derived classes call their base class conterparts first, and below is a wrong version to make the <code>SpecialWindow::onResize()</code> (derived class virtual function) to invoke its base class <code>Window</code>&rsquo;s conterparts:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Window</span> {  <span style="color:#75715e">// baes class
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> onResize();  <span style="color:#75715e">// base on Resize impl
</span><span style="color:#75715e"></span>    ...
};
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpecialWindow</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> Window {  <span style="color:#75715e">// derived class
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> onResize() {  <span style="color:#75715e">// derived onResize impl
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>Window<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>).onResize(); <span style="color:#75715e">// cast *this to Window, then call its onResize
</span><span style="color:#75715e"></span>        ... <span style="color:#75715e">// do SpecialWindow-specific stuff
</span><span style="color:#75715e"></span>    }
    ...
};
</code></pre></div>
<p>The code casts <code>*this</code> to a <code>Windnow</code>, so the call to <code>onResize</code> will invoke <code>Window::onResize</code>. However, surprisingly, the cast will secretly create a new, temporary <em>copy</em> of the base class part of <code>*this</code>, then invoke <code>onResize</code> on the copy - the <code>Window::onResize</code> does not apply on the current object, while the <code>SpecialWindow</code>-specific actions apply on that object, leading to the prospect that the code will leave the current object in an invalid state, if the base class virtual function is supposed to do some modifications on current object but fails to do so.</p>

<p>The solution is to eliminate the cast, and call the base class version of <code>onResize</code> on the current object:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpecialWindow</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> Window {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> onResize() {
        Window<span style="color:#f92672">:</span><span style="color:#f92672">:</span>onResize();  <span style="color:#75715e">// call Window::onResize on *this
</span><span style="color:#75715e"></span>        ...
    }
    ...
}
</code></pre></div>
<h2 id="cost-of-dynamic-cast">Cost of <code>dynamic_cast</code></h2>

<p>One common implementatino of <code>dynamic_cast</code> is based in part on string comparisons of class names, so if we&rsquo;re performing a <code>dynamic_cast</code> on an object in a single-inheritance hierarchy four levels deep, each <code>dynamic_cast</code> could cost us up to four calls to <code>strcmp</code>. A deeper hierarchy or one using multiple inheritance would be more expensive. So for performance-sensitive code, we should be especially leery of <code>dynamic_cast</code>.</p>

<p>When we need <code>dynamic_cast</code>? Generally, the need arises because we want to perform derived class operations on a derived class object via a base pointer or base reference. Say in our <code>Window</code>/<code>SpecialWindow</code> hierarchy, only <code>SpecialWindow</code> supports blinking, so we may use <code>dynamic_cast</code> this way:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Window</span> {...};
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpecialWindow</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> Window {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">void</span> blink();
    ...
};
<span style="color:#66d9ef">typedef</span> std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>tr1<span style="color:#f92672">:</span><span style="color:#f92672">:</span>shared_ptr<span style="color:#f92672">&lt;</span>Window<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> VPW; <span style="color:#75715e">// item 13 on tr1::shared_ptr
</span><span style="color:#75715e"></span>
VPW winPtrs;
...
<span style="color:#66d9ef">for</span> (VPW<span style="color:#f92672">:</span><span style="color:#f92672">:</span>iterator iter <span style="color:#f92672">=</span> winPtrs.begin();
    iter <span style="color:#f92672">!</span><span style="color:#f92672">=</span> winPtrs.end();
    <span style="color:#f92672">+</span><span style="color:#f92672">+</span>iter) {
        <span style="color:#66d9ef">if</span> (SpecialWindow <span style="color:#f92672">*</span>psw <span style="color:#f92672">=</span> <span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>SpecialWindow<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>(iter<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>get())) {
            psw<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>blink();
        }
    }
</code></pre></div>
<p>In order to eliminate the <code>dynamic_cast</code>, there are two approaches:</p>

<ol>
<li><p>Use specific containers<br />
We could use containers that store pointers to derived class objects directly, so that there&rsquo;s no need to manipulate derived class through base class interfaces:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">typedef</span> std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>tr1<span style="color:#f92672">:</span><span style="color:#f92672">:</span>shared_ptr<span style="color:#f92672">&lt;</span>SpecialWindow<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> VPSW;

VPSW winPtrs;
...
<span style="color:#66d9ef">for</span> (VPSW<span style="color:#f92672">:</span><span style="color:#f92672">:</span>iterator iter <span style="color:#f92672">=</span> winPtrs.begin();
    iter <span style="color:#f92672">!</span><span style="color:#f92672">=</span> winPtrs.end();
    <span style="color:#f92672">+</span><span style="color:#f92672">+</span>iter) {
        (<span style="color:#f92672">*</span>iter)<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>blink();
    }
</code></pre></div>
<p>Of course, we cannot store all possible <code>Window</code> derivatives in the same container under this approach, instead, we may work with multiple type-safe containers.</p></li>

<li><p>Use virtual functions<br />
If we insist on manipulating all possible <code>Window</code> derivatives through a base class interface, we could declare a useless <code>blink</code> as a virtual functions in base class (if it makes sense):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Window</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> blink() {}  <span style="color:#75715e">// default impl is no-op; see item 34 for why a default impl may be a bad idea
</span><span style="color:#75715e"></span>    ...
};
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpecialWindow</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> Window {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> blink() {...};  <span style="color:#75715e">// do something in blink
</span><span style="color:#75715e"></span>    ...
};
<span style="color:#66d9ef">typedef</span> std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>tr1<span style="color:#f92672">:</span><span style="color:#f92672">:</span>shared_ptr<span style="color:#f92672">&lt;</span>Window<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> VPW;

VPW winPtrs;  <span style="color:#75715e">// container holds ptrs to all possible Window types
</span><span style="color:#75715e"></span>...
<span style="color:#66d9ef">for</span> (VPW<span style="color:#f92672">:</span><span style="color:#f92672">:</span>iterator iter <span style="color:#f92672">=</span> winPtrs.begin();
    iter <span style="color:#f92672">!</span><span style="color:#f92672">=</span> winPtrs.end();
    <span style="color:#f92672">+</span><span style="color:#f92672">+</span>iter) {
        (<span style="color:#f92672">*</span>iter)<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>blink();  <span style="color:#75715e">// no dynamic_cast
</span><span style="color:#75715e"></span>    }
</code></pre></div></li>
</ol>

<p>Neigther of two approaches above are universally applicable, but they do provide a viable alternative to <code>dynamic_cast</code>. As long as they work, we should embrace them.</p>

<p>Another thing we want to avoid about <code>dynamic_casts</code> is designs that involve cascading <code>dynamic_casts</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Window</span> {...};
...  <span style="color:#75715e">// derived clases
</span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>tr1<span style="color:#f92672">:</span><span style="color:#f92672">:</span>shard_ptr<span style="color:#f92672">&lt;</span>Window<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> VPW;

VPW winPtrs;
...
<span style="color:#66d9ef">for</span> (VPW<span style="color:#f92672">:</span><span style="color:#f92672">:</span>iterator iter <span style="color:#f92672">=</span> winPtrs.begin(); 
    iter <span style="color:#f92672">!</span><span style="color:#f92672">=</span> winPtrs.end(); 
    <span style="color:#f92672">+</span><span style="color:#f92672">+</span>iter) {
        <span style="color:#66d9ef">if</span> (SpecialWindow1 <span style="color:#f92672">*</span>psw1 <span style="color:#f92672">=</span> 
            <span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>SpecialWindow1<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>(iter<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>get())) {...}
        <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (SpecialWindow2 <span style="color:#f92672">*</span>psw2 <span style="color:#f92672">=</span> 
            <span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>SpecialWindow2<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>(iter<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>get())) {...}
        <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (SpecialWindow3 <span style="color:#f92672">*</span>psw3 <span style="color:#f92672">=</span> 
            <span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>SpecialWindow3<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>(iter<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>get())) {...} 
        ...        
    }
</code></pre></div>
<p>This design generates code that is big and slow, and is hard to maintain, for we have to update the condition branch every time we update the base class <code>Window</code>. Code like this should almost always be replaced with something based on virtual funciton calls.</p>

<p>In summary, although it&rsquo;s generally not practical to get rid of casts, we should use as few as possible. If we have to use them, like most suspicious constructs, we should isolate casts as much as possible, typically hide them inside functions whose interfaces shiled callers from the work inside.</p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="http://nianze.tk/tags/technique/">technique</a>

  <a class="tag tag--primary tag--small" href="http://nianze.tk/tags/cpp/">cpp</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/02/avoid-return-handles-to-obejct-internals/" data-tooltip="Item-28 Avoid returning handles to object internals">
              
                  <i class="fas fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/02/postpone-variable-definitions/" data-tooltip="Item-26 Postpone variable definitions as long as possible">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fas fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fas fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://nianze.tk/2018/02/minimize-casting/">
              <i class="fab fa-facebook-f"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://nianze.tk/2018/02/minimize-casting/">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://nianze.tk/2018/02/minimize-casting/">
              <i class="fab fa-google-plus-g"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#utteranc_thread" data-tooltip="Comments">
            <i class="fas fa-comment-dots"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
            <i class="fas fa-arrow-up"></i>
        
          </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="utteranc_thread">
  <script src="https://utteranc.es/client.js"
    repo= "Nianze/personal-site-comments"
    issue-term="pathname"
    theme="github-light"
    label="✨comment 💬"
    crossorigin="anonymous"
    async>
  </script>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2019 刀心の水. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/02/avoid-return-handles-to-obejct-internals/" data-tooltip="Item-28 Avoid returning handles to object internals">
              
                  <i class="fas fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/02/postpone-variable-definitions/" data-tooltip="Item-26 Postpone variable definitions as long as possible">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fas fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fas fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://nianze.tk/2018/02/minimize-casting/">
              <i class="fab fa-facebook-f"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://nianze.tk/2018/02/minimize-casting/">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://nianze.tk/2018/02/minimize-casting/">
              <i class="fab fa-google-plus-g"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#utteranc_thread" data-tooltip="Comments">
            <i class="fas fa-comment-dots"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
            <i class="fas fa-arrow-up"></i>
        
          </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fas fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fnianze.tk%2F2018%2F02%2Fminimize-casting%2F">
          <i class="fa fa-facebook-f"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http%3A%2F%2Fnianze.tk%2F2018%2F02%2Fminimize-casting%2F">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http%3A%2F%2Fnianze.tk%2F2018%2F02%2Fminimize-casting%2F">
          <i class="fa fa-google-plus-g"></i><span>Share on Google&#43;</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fas fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="http://nianze.tk/images/profile/bw.JPG" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">刀心の水</h4>
    
      <div id="about-card-bio"><p>虚度廿余岁月浅，略识几行代码源。<br />
闲来随手快门按，怆然独把音韵弹。</p>

<p>Pain is inevitable.<br />
Suffering is optional.</p>
</div>
    
    
      <div id="about-card-job">
        <i class="fas fa-laptop-code"></i>
        <br/>
        Developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fas fa-map-marked-alt"></i>
        <br/>
        New York
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('http://nianze.tk/images/profile/road.JPG');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/3.2.0/imagesloaded.pkgd.min.js"></script>


<script src="http://nianze.tk/js/script-qi9wbxp2ya2j6p7wx1i6tgavftewndznf4v0hy2gvivk1rxgc3lm7njqb6bz.min.js"></script>


  
    <script src="http://nianze.tk/js/loader.js"></script>
  

<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>





    
  </body>
</html>


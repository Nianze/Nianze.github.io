<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="刀心の水">
<meta name="keywords" content=", visual, music, technology">
<meta name="description" content="Exception-safe functions leak no resources and allow no data structures to become corrupted, even when exceptions are thrown. Such functions offer the basic, strong, and nothrow guarantees.">


<meta property="og:description" content="Exception-safe functions leak no resources and allow no data structures to become corrupted, even when exceptions are thrown. Such functions offer the basic, strong, and nothrow guarantees.">
<meta property="og:type" content="article">
<meta property="og:title" content="Item-29 Strive for exception-safe code">
<meta name="twitter:title" content="Item-29 Strive for exception-safe code">
<meta property="og:url" content="http://nianze.tk/2018/02/strive-for-exception-safe-code/">
<meta property="twitter:url" content="http://nianze.tk/2018/02/strive-for-exception-safe-code/">
<meta property="og:site_name" content="Be creative">
<meta property="og:description" content="Exception-safe functions leak no resources and allow no data structures to become corrupted, even when exceptions are thrown. Such functions offer the basic, strong, and nothrow guarantees.">
<meta name="twitter:description" content="Exception-safe functions leak no resources and allow no data structures to become corrupted, even when exceptions are thrown. Such functions offer the basic, strong, and nothrow guarantees.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2018-02-20T18:23:38">
  
  
    <meta property="article:modified_time" content="2018-02-20T18:23:38">
  
  
  
    
      <meta property="article:section" content="technology">
    
      <meta property="article:section" content="coding">
    
  
  
    
      <meta property="article:tag" content="technique">
    
      <meta property="article:tag" content="cpp">
    
  


<meta name="twitter:card" content="summary">







  <meta property="og:image" content="http://nianze.tk/images/2018/2018-02/2018-02-20.gif">
  <meta property="twitter:image" content="http://nianze.tk/images/2018/2018-02/2018-02-20.gif">





  <meta property="og:image" content="http://nianze.tk/images/bw.JPG">
  <meta property="twitter:image" content="http://nianze.tk/images/bw.JPG">


    <title>Item-29 Strive for exception-safe code</title>

    <link rel="icon" href="http://nianze.tk/favicon.png">
    

    

    <link rel="canonical" href="http://nianze.tk/2018/02/strive-for-exception-safe-code/">

    
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="http://nianze.tk/css/style-nnm2spxvve8onlujjlegkkytaehyadd4ksxc1hyzzq9a2wvtrgbljqyulomn.min.css" />
    
    
      
        <link rel="stylesheet" href="http://nianze.tk/css/main.css">
      
    
      
        <link rel="stylesheet" href="http://nianze.tk/css/loader.css">
      
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-71584380-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
    
  </head>

  <body id="container">
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fas fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="http://nianze.tk/">Be creative</a>
  </div>
  
    
      <a class="header-right-picture "
         href="http://nianze.tk/#about">
    
    
    
      
        <img class="header-picture" src="http://nianze.tk/images/bw.JPG" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="http://nianze.tk/#about">
          <img class="sidebar-profile-picture" src="http://nianze.tk/images/bw.JPG" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">刀心の水</h4>
        
          <h5 class="sidebar-profile-bio"><p>虚度廿余岁月浅，略识几行代码源。<br />
闲来随手快门按，怆然独把音韵弹。</p>

<p>Pain is inevitable.<br />
Suffering is optional.</p>
</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/">
    
      <i class="sidebar-button-icon fas fa-home" title='Home'></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/thoughts">
    
      <i class="sidebar-button-icon fas fa-lightbulb" title='Thoughts'></i>
      
      <span class="sidebar-button-desc">Thoughts</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/technology">
    
      <i class="sidebar-button-icon fas fa-code" title='Technology'></i>
      
      <span class="sidebar-button-desc">Technology</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/music">
    
      <i class="sidebar-button-icon fas fa-music" title='Music'></i>
      
      <span class="sidebar-button-desc">Music</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/visual">
    
      <i class="sidebar-button-icon fas fa-palette" title='Visual'></i>
      
      <span class="sidebar-button-desc">Visual</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories">
    
      <i class="sidebar-button-icon fas fa-bookmark" title='Categories'></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/tags">
    
      <i class="sidebar-button-icon fas fa-tags" title='Tags'></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/archives">
    
      <i class="sidebar-button-icon fas fa-archive" title='Archives'></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/about">
    
      <i class="sidebar-button-icon fas fa-user" title='About'></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.linkedin.com/in/nianze" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-linkedin" title='LinkedIn'></i>
      
      <span class="sidebar-button-desc">LinkedIn</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/Nianze" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-github" title='Github'></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.flickr.com/photos/129774362@N07/" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-flickr", title='Flickr'></i>
      
      <span class="sidebar-button-desc">Flickr</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://instagram.com/eznain" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-instagram" title='Instagram'></i>
      
      <span class="sidebar-button-desc">Instagram</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.facebook.com/rym.lnz" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-facebook", title='Facebook'></i>
      
      <span class="sidebar-button-desc">Facebook</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/daoxinzhishui" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-twitter", title='Twitter'></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.youtube.com/user/daoxinzhishui" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-youtube", title='YouTube'></i>
      
      <span class="sidebar-button-desc">YouTube</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="mailto:daoxinzhishui@gmail.com" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fas fa-envelope", title='Email'></i>
      
      <span class="sidebar-button-desc">Email</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/post/index.xml">
    
      <i class="sidebar-button-icon fas fa-rss-square", title='RSS'></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Item-29 Strive for exception-safe code
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2018-02-20T18:23:38-05:00">
        
  February 20, 2018

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="http://nianze.tk/categories/technology">technology</a>, 
    
      <a class="category-link" href="http://nianze.tk/categories/coding">coding</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>Exception-safe functions leak no resources and allow no data structures to become corrupted, even when exceptions are thrown. Such functions offer the basic, strong, and nothrow guarantees.</p>

<h1 id="table-of-contents">Table of Contents</h1><nav id="TableOfContents">
<ul>
<li><a href="#example">Example</a>
<ul>
<li><a href="#resource-leak">Resource leak</a></li>
<li><a href="#data-structure-corruption">Data structure corruption</a>
<ul>
<li><a href="#copy-and-swap-strategy">Copy-and-<code>swap</code> strategy</a></li>
<li><a href="#side-effects-and-efficiency">Side effects and efficiency</a>
<ul>
<li><a href="#1-side-effects">1. Side effects</a></li>
<li><a href="#2-efficiency">2. Efficiency</a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="#in-practice">In practice</a></li>
</ul>
</nav>

<p>For exception-safe functions, there are two requirements when an exception is thrown:</p>

<ol>
<li>Leak no resources</li>
<li>Don&rsquo;t allow data structures to become corrupted</li>
</ol>

<p>Specifically, from the perspective of data structure corruption, exception-safe functions must offer one of three guarantees below from the weakest to the strongest:</p>

<ol>
<li>The <strong>basic guarantee</strong> promises that if an exception is thrown, everything in the program remains in a valid state - all class invariants are satisfied, but the exact state of the program may not be predictable.</li>
<li>The <strong>strong guarantee</strong> promises that if an exception is thrown, the state of the program is unchanged - calls to such functions are <em>atomic</em> in the sense that if they succeed, they successd completely, and if they fail, the program state is as if they&rsquo;d never been called.</li>
<li>The <strong>nothrow guarantee</strong> promises never to throw exceptions - all operators on built-in types (e.g., <code>int</code>s, pointers, etc.) are nothrow. This is a critical building block of exception-safe code.</li>
</ol>

<h1 id="example">Example</h1>

<p>With all these terminologies bear in mind, let&rsquo;s see an example representing exception-unsafe style. Suppose there&rsquo;s a class for GUI menus with background images, and it will be used in a threaded environment, so it has a mutex for concurrency control:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PrettyMenu</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    ...
    <span style="color:#66d9ef">void</span> changeBackGround(std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>istream<span style="color:#f92672">&amp;</span> imgSrc); <span style="color:#75715e">// change background image
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    Mutex mutex;      <span style="color:#75715e">// mutex for this obejct
</span><span style="color:#75715e"></span>    Image <span style="color:#f92672">*</span>bgImage;   <span style="color:#75715e">// current background image
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> imageChanges; <span style="color:#75715e">// # of times image has been changed
</span><span style="color:#75715e"></span>};
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> PrettyMenu<span style="color:#f92672">:</span><span style="color:#f92672">:</span>changeBackground(std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>istream<span style="color:#f92672">&amp;</span> imgSrc)
{
    lock(<span style="color:#f92672">&amp;</span>mutex);   <span style="color:#75715e">// acquire mutex (item 14)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">delete</span> bgImage; <span style="color:#75715e">// get rid of old background
</span><span style="color:#75715e"></span>    <span style="color:#f92672">+</span><span style="color:#f92672">+</span>imageChanges; <span style="color:#75715e">// update image change count
</span><span style="color:#75715e"></span>    bgImage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Image(imgSrc); <span style="color:#75715e">// install new background
</span><span style="color:#75715e"></span>    unlock(<span style="color:#f92672">&amp;</span>mutex); <span style="color:#75715e">// release mutex 
</span><span style="color:#75715e"></span>}
</code></pre></div>
<p>Firstly, the code above is likely to encounter resource leak, because if the <code>new Image(imgSrc)</code> expression yields an exception, the call to <code>unlock</code> never gets executed, and the mutex is held forever.</p>

<p>Secondly, this function guarantees none of the 3 promises in terms of data structure corruption above: when <code>new Image(Src)</code> throws, <code>bgImage</code> is left pointing to a deleted object, and <code>imageChanges</code> has been increamented before the new image has been installed, resulting to invalid object state.</p>

<h2 id="resource-leak">Resource leak</h2>

<p>To address the resource leak issue, we can use objects to manage resources (item 13), and take advantage of <code>Lock</code> class to ensure that mutexes are released in a timely fashion (item 14):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> PrettyMenu<span style="color:#f92672">:</span><span style="color:#f92672">:</span>changeBackground(std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>istream<span style="color:#f92672">&amp;</span> imgSrc)
{
    Lock <span style="color:#a6e22e">ml</span>(<span style="color:#f92672">&amp;</span>mutex);   <span style="color:#75715e">// item 14: acquire mutex and ensure its later release
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">delete</span> bgImage; 
    <span style="color:#f92672">+</span><span style="color:#f92672">+</span>imageChanges; <span style="color:#75715e">// update image change count
</span><span style="color:#75715e"></span>    bgImage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Image(imgSrc); <span style="color:#75715e">// install new background
</span><span style="color:#75715e"></span>}
</code></pre></div>
<h2 id="data-structure-corruption">Data structure corruption</h2>

<p>To address the issue of data structure corruption, we may need to determine which guarantee to offer. As a general rule,</p>

<blockquote>
<p>we want to offer <em>the strongest</em> guarantee that&rsquo;s <em>practical</em>.</p>
</blockquote>

<p>Note the word <em>practical</em>. We definitely want to offer nothrow guarantee for every functions we write, but it&rsquo;s hard to keep such a promise - to name a common exception: anything using dynamically allocated memory (e.g., all STL containers) runs the risk of a <code>bad_alloc</code> exception if it can&rsquo;t find enough memory to satisfy a request (item 49). For most functions, the choice for us is between the basic and strong guarantees.</p>

<p>In the case of <code>changeBackground</code>, <em>almost</em> offering the strong guarantee is not difficult:</p>

<ul>
<li>firstly, we change the type of <code>bgImage</code> data member in <code>PrettyMunu</code> from a built-in <code>Image*</code> pointer to smart pointer such as <code>tr1::shraed_ptr</code> (item 13), which benefits us with

<ol>
<li>preventing resource leaks</li>
<li>offering strong exception safety guarantee</li>
</ol></li>

<li><p>secondly, we reorder the statements so that we don&rsquo;t increment <code>imageChanges</code> until the image has been changed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PrettyMenu</span> {
...
std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>tr1<span style="color:#f92672">:</span><span style="color:#f92672">:</span>shared_ptr<span style="color:#f92672">&lt;</span>Imgae<span style="color:#f92672">&gt;</span> bgImage;
...
};
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> PrettyMenu<span style="color:#f92672">:</span><span style="color:#f92672">:</span>changeBackground(std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>istream<span style="color:#f92672">&amp;</span> imgSrc)
{
Lock <span style="color:#a6e22e">ml</span>(<span style="color:#f92672">&amp;</span>mutex);
bgImage.reset(<span style="color:#66d9ef">new</span> Image(imgSrc)); <span style="color:#75715e">// replace bgImage&#39;s internal pointer with the
</span><span style="color:#75715e"></span>                                  <span style="color:#75715e">// result of the &#34;new Image&#34; expression
</span><span style="color:#75715e"></span><span style="color:#f92672">+</span><span style="color:#f92672">+</span>imageChanges;
}
</code></pre></div></li>
</ul>

<p>Note how the use of resource magangement object (i.e., the smart pointer here) helps:</p>

<ol>
<li>The <code>tr1::shared_ptr::reset</code> function will be called only if its parameter (the result of <code>new Image(imgSrc)</code>) is successfully created</li>
<li>The <code>delete</code> operation for the old image is inside the <code>reset</code>, so if the <code>reset</code> function is never entered (the program somehow fails to create new image), the deletion of the old image will never take place</li>
<li>As a result, the deletion takes place only if the new image is successfully created</li>
<li>We don&rsquo;t need to manually <code>delete</code> the old image, and the length of <code>changeBackground</code> reduces</li>
</ol>

<p>After these two changes, <code>changeBackground</code> <em>almost</em> offer the strong exception safety guarantee. The only weakness now is the parameter <code>imgSrc</code>: if the <code>Image</code> constructor throws an exception, it&rsquo;s possible that the read marker for the input stream has been moved, which is a change in state visible to the rest of the program, leading to offering only the basic exception safety guarantee.</p>

<h3 id="copy-and-swap-strategy">Copy-and-<code>swap</code> strategy</h3>

<p>There actually is a general design strategy for offering the strong guarantee:</p>

<blockquote>
<p><strong>copy and swap</strong> strategy:<br />
Make a copy of the object we want to modify, then make all needed changes to the copy;<br />
- If all the changes have been successfully completed, swap the modified object with the original in a non-throwing operation (item 25);<br />
- If any of the modifying operations throws an exception, the original object remains unchanged.</p>
</blockquote>

<p>The strategy is usually implemented by putting all the per-object data from the &ldquo;real&rdquo; object into a separate implementation object, then giving the real object a pointer to its implementation object (know as the &ldquo;pimpl idiom&rdquo;, item 31). For <code>PrettyMenu</code>, it would look something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">PMImpl</span> {  <span style="color:#75715e">// PMIpml = &#34;PrettyMenu Impl.&#34;
</span><span style="color:#75715e"></span>    std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>tr1<span style="color:#f92672">:</span><span style="color:#f92672">:</span>shared_ptr<span style="color:#f92672">&lt;</span>Image<span style="color:#f92672">&gt;</span> bgImage; 
    <span style="color:#66d9ef">int</span> imageChanges; 
};

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PrettyMenu</span> {
...
<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    Mutex mutex;
    std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>tr1<span style="color:#f92672">:</span><span style="color:#f92672">:</span>shared_ptr<span style="color:#f92672">&lt;</span>PMImpl<span style="color:#f92672">&gt;</span> pImpl;
};
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> PrettyMenu<span style="color:#f92672">:</span><span style="color:#f92672">:</span>changeBackground(std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>istream<span style="color:#f92672">&amp;</span> imgSrc)
{
    <span style="color:#66d9ef">using</span> std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>swap;  <span style="color:#75715e">// item 25
</span><span style="color:#75715e"></span>    Lock <span style="color:#a6e22e">ml</span>(<span style="color:#f92672">&amp;</span>mutex);  <span style="color:#75715e">// acquire the mutex
</span><span style="color:#75715e"></span>    
    std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>tr1<span style="color:#f92672">:</span><span style="color:#f92672">:</span>shared_ptr<span style="color:#f92672">&lt;</span>PMImpl<span style="color:#f92672">&gt;</span> pNew(<span style="color:#66d9ef">new</span> PMImpl(<span style="color:#f92672">*</span>pImpl));  <span style="color:#75715e">// copy obj. data
</span><span style="color:#75715e"></span>    pNew<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>bgImage.reset(<span style="color:#66d9ef">new</span> Image(imgSrc)); <span style="color:#75715e">// modify the copy
</span><span style="color:#75715e"></span>    <span style="color:#f92672">+</span><span style="color:#f92672">+</span>pNew<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>imageChanges;
    swap(pImpl, pNew);  <span style="color:#75715e">// swap the new data into place
</span><span style="color:#75715e"></span>} <span style="color:#75715e">// release the mutex
</span></code></pre></div>
<p>We don&rsquo;t have to make the struct <code>PMImpl</code> as a class, because the encapsulation of <code>PrettyMenu</code> data is assured by <code>pImpl</code> being private, and it is more convenient to use struct. If desired, <code>PMImpl</code> could be nested inside <code>PrettyMenu</code> when considering packaging issues.</p>

<h3 id="side-effects-and-efficiency">Side effects and efficiency</h3>

<p>Even with the help of copy-and-<code>swap</code> strategy, there are two possible reasons that downgrade the overall exception safety level from strong to basic: <em>side effects</em> and <em>efficiency</em>.</p>

<h4 id="1-side-effects">1. Side effects</h4>

<p>Suppose <code>someFunc</code> uses copy-and-<code>swap</code> and includes calls to two other functions, <code>f1</code> and <code>f2</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">someFunc</span>()
{
    ...    <span style="color:#75715e">// make copy of local state
</span><span style="color:#75715e"></span>    f1();
    f2();
    ...    <span style="color:#75715e">// swap modified state into place
</span><span style="color:#75715e"></span>}
</code></pre></div>
<p>Apparently, if <code>f1</code> or <code>f2</code> is less than strongly exception-safe, it will be hard for <code>someFunc</code> to be strong exception-safe. For example, suppose <code>f1</code> offers only the basic guarantee, in order to offer the strong guarantee for <code>someFunc</code>, we have to write code to determine the state of the entire program before calling <code>f1</code>, catch all exceptions from <code>f1</code>, and then store the original state. It&rsquo;s complicated, but it&rsquo;s doable. However, even if <code>f1</code> and <code>f2</code> are both strongly exception safe, as long as there are side effects on non-local data, it&rsquo;s much harder to offer the strong guarantee.</p>

<p>For example, if a side effect of calling <code>f1</code> is that a database is modified, and there is, in general, no way to undo a database modification that has already been committed; so after successfully calling <code>f1</code>, if <code>f2</code> then throws an exception, the state of the program is not the same as it was when calling <code>someFunc</code>, even though <code>f2</code> didn&rsquo;t change anything.</p>

<h4 id="2-efficiency">2. Efficiency</h4>

<p>Copy and <code>swap</code> strategy requires making a copy of each object to be modified, which takes time and space we may be unable or unwilling to make available. It&rsquo;s just not practical 100% of the time when we want to offer the strong guarantee.</p>

<p>When it&rsquo;s not, we&rsquo;ll have to offer the basic guarantee. In practice, we can usually offer the strong guarantee for some functions, but the const in efficiency or complexity will make it untenable for many others. For those functions, the basic guarantee is a perfectly resonable choice, as long as we&rsquo;ve made a reasonable effort to offer the strong guarantee whenever it&rsquo;s practical.</p>

<h1 id="in-practice">In practice</h1>

<p>A software system is either exception-safe or it&rsquo;s not. There&rsquo;s no such thing as a partially exception-safe system. If a system has even a single function that&rsquo;s not exception-safe, the system as a whole is not exception-safe. Unfortunately, much C++ legacy code was written without exception safety in mind, so many system incorporating legacy code today are not exception-safe.</p>

<p>There&rsquo;s no reason to perpetuate this state of affairs. When writing new code or modifying existing code, think carefully about how to make it exception-safe:</p>

<ol>
<li>begin by using objects to manage resources to prevent resource leaks</li>
<li>follow by determining which of the three exception safety guarantees is the strongest we cound practically offer for each function, settling for no guarantee only if calls to legacy code leave us no choice.</li>
<li>Document our decisions, both for clients of our functions and for future maintainers - a function&rsquo;s exception-safety guaranteee is a visible part of its interface, so we should choose it as deliberately as we choose all other aspects of a function&rsquo;s interface.</li>
</ol>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="http://nianze.tk/tags/technique/">technique</a>

  <a class="tag tag--primary tag--small" href="http://nianze.tk/tags/cpp/">cpp</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/02/ins-and-outs-of-inlining/" data-tooltip="Item-30 Understand ins and outs of inlining">
              
                  <i class="fas fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/02/avoid-return-handles-to-obejct-internals/" data-tooltip="Item-28 Avoid returning handles to object internals">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fas fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fas fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://nianze.tk/2018/02/strive-for-exception-safe-code/">
              <i class="fab fa-facebook-f"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://nianze.tk/2018/02/strive-for-exception-safe-code/">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://nianze.tk/2018/02/strive-for-exception-safe-code/">
              <i class="fab fa-google-plus-g"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#utteranc_thread" data-tooltip="Comments">
            <i class="fas fa-comment-dots"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#table-of-contents" data-tooltip="Table of Contents">
            <i class="fas fa-list"></i>
        
          </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="utteranc_thread">
  <script src="https://utteranc.es/client.js"
    repo= "Nianze/personal-site-comments"
    issue-term="pathname"
    theme="github-light"
    label="✨comment 💬"
    crossorigin="anonymous"
    async>
  </script>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2019 刀心の水. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/02/ins-and-outs-of-inlining/" data-tooltip="Item-30 Understand ins and outs of inlining">
              
                  <i class="fas fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/02/avoid-return-handles-to-obejct-internals/" data-tooltip="Item-28 Avoid returning handles to object internals">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fas fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fas fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://nianze.tk/2018/02/strive-for-exception-safe-code/">
              <i class="fab fa-facebook-f"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://nianze.tk/2018/02/strive-for-exception-safe-code/">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://nianze.tk/2018/02/strive-for-exception-safe-code/">
              <i class="fab fa-google-plus-g"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#utteranc_thread" data-tooltip="Comments">
            <i class="fas fa-comment-dots"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#table-of-contents" data-tooltip="Table of Contents">
            <i class="fas fa-list"></i>
        
          </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fas fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fnianze.tk%2F2018%2F02%2Fstrive-for-exception-safe-code%2F">
          <i class="fa fa-facebook-f"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http%3A%2F%2Fnianze.tk%2F2018%2F02%2Fstrive-for-exception-safe-code%2F">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http%3A%2F%2Fnianze.tk%2F2018%2F02%2Fstrive-for-exception-safe-code%2F">
          <i class="fa fa-google-plus-g"></i><span>Share on Google&#43;</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fas fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="http://nianze.tk/images/bw.JPG" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">刀心の水</h4>
    
      <div id="about-card-bio"><p>虚度廿余岁月浅，略识几行代码源。<br />
闲来随手快门按，怆然独把音韵弹。</p>

<p>Pain is inevitable.<br />
Suffering is optional.</p>
</div>
    
    
      <div id="about-card-job">
        <i class="fas fa-laptop-code"></i>
        <br/>
        Developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fas fa-map-marked-alt"></i>
        <br/>
        New York
      </div>
    
  </div>
</div>

    

    
  
    
      
      <div id="cover" style="background-image:url('http://nianze.tk/images/reservoir.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/3.2.0/imagesloaded.pkgd.min.js"></script>


<script src="http://nianze.tk/js/script-qi9wbxp2ya2j6p7wx1i6tgavftewndznf4v0hy2gvivk1rxgc3lm7njqb6bz.min.js"></script>


  
    <script src="http://nianze.tk/js/loader.js"></script>
  

<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>





    
  </body>
</html>

